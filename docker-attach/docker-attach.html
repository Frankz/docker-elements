<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../x-websocket/dist/x-websocket.html">
<script src="term.js"></script>

<dom-module id="docker-attach">
	<template>
		<style>
		#terminal {
			overflow-y: auto;
			height:600px;			
		}
		</style>
		<x-websocket id="webSocket" url="{{url}}"></x-websocket>
		<div id="terminal"></div>
	</template>
</dom-module>

<script>
	Polymer({
		is: 'docker-attach',
		properties: {
			containerid : {
				type: String
			},
			host: {
				type: String
			},
			url: {
  				type: String,
  				computed: 'computeUrl(host, containerid)'
			},
			term: {
				type: Object,
				value: function() {
					return new Terminal({
			            cols: 125, //125
			            rows: 24, //24
			            convertEol: true,
			            useStyle: true,
			            cursorBlink: true,
			            screenKeys: true
			        });
				}
			},
			logs: {
				type: Number,
				value: 0
			},
			stream :{
				type: Number,
				value: 1
			},
			stdin: {
				type: Number,
				value: 1
			},
			stdout: {
				type: Number,
				value: 1
			},
			stderr: {
				type: Number,
				value: 1
			},
			readonly: {
				type: Boolean,
				value: false
			},
			windows: {
				type: Boolean,
				value: false
			},
			command: {
				type: String,
				value: ''
			}
		},
		listeners: {
			'message': 'handleReceive'
		},
		computeUrl: function(host, containerid) {
			return "ws://" + host +"/containers/" + containerid + "/attach/ws?logs="+this.logs+"&stream="+this.stream+"&stdin="+this.stdin+"&stdout="+this.stdout+"&stderr="+this.stderr;
		},

		ready: function() {
			this.$.webSocket.open();			
			if (!this.readonly)
			{
				var that = this;
				this.term.on('data', function(data) {	  
	            	if(that.windows && data == '') { 
	            		//Backspace	in windows
	            		that.$.webSocket.send(unescape('%08'));
	            	} else {
	            		that.$.webSocket.send(data);	
	            	}	            	
	          	});
			}
			if(this.windows) {
				this.term.colors[256] = "#2e3436";
			}
			this.term.colors[256] = "#2e3436";
			this.term.open(this.$.terminal);
		},
		attached: function() {
			if(this.command != "") {
				this.$.webSocket.send(this.command+"\n");
			} else {
				this.$.webSocket.send("\n");
			}
			document.querySelector(".terminal").style.borderRadius = "12px";
		},
		handleReceive: function(e) {
			this.term.write(e.detail.data);			
		}


	});
</script>